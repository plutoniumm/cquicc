<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/aaaakshat/cm-web-fonts@latest/fonts.css">
  <link rel="stylesheet" href="https://manav.ch/atomic.css">
  <link rel="stylesheet" href="/cquicc.css">
  <link rel="stylesheet" href="/hljs.css">
  <script src="/process.js"></script>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize( { securityLevel: 'antiscript', theme: "base" } );
    loop( () => mermaid.init( undefined, $$( '.mermaid' ) ) )
  </script>
  <script>
    let alerts = []; // type, text
    loop( () => {
      $( ".split" ).style.height = "calc(29.7cm - 3em - 4cm)";
      const vars = JSON.parse(
        document.body.getAttribute( "vars" )
          .replaceAll( "&quot;", "\"" )
      )

      // process citations
      const processed = $$( "a[href*='ref']" ).forEach( e => {
        let [ num, ...rest ] = e.innerText.split( "." );
        rest = rest.join( "." );

        e.outerHTML =
          `<def id="fn${ num }">
            <a href="${ e.href + num }" style="color:#000;">[${ num }]</a>
            ${ rest }
          </def>`;
      } );

      // other splits after first
      $$( ".split" ).slice( 1 ).forEach( ( split, index ) => {
        const exists = document.querySelector( `#top${ index }` );
        if ( exists ) return;

        const hr = document.createElement( "hr" );
        hr.id = `top${ index }`;
        split.insertBefore( hr, split.firstChild );
      } );

      $$( ".postp" ).forEach( ( e, i ) => {
        e.innerHTML = `<div>${ vars.author }, ${ vars.from }</div>
        <div>${ i + 1 }</div>`
      } );

      $$( "img,svg" ).forEach( e => {
        const text = e.outerHTML.slice( 0, 100 );
        const tag = e.tagName.toLowerCase();

        let url = e.getAttribute( "url" ) || e.getAttribute( "src" );
        if ( !url )
          return alerts.push( [ tag + "-src", "No url/src for: " + text ] );
        url = new URL( url, window.location.href ).hostname;

        const alt = e.getAttribute( "alt" );
        if ( !alt )
          return alerts.push( [ tag + "-alt", "No alt for:" + text ] );

        const grey = `<div class="img-expl">
          ${ alt.replaceAll( "\"", "" ) }, <i>${ url }</i>
        </div>`;
        e.insertAdjacentHTML( "afterend", grey );
      } );

      alerts.forEach( ( [ type, text ] ) => {
        console.log( `%c${ type }: $c${ text }`, "color: red;", "color: black;" );
      } )
    } );
  </script>

  &head;
</head>

<body class="flow-x-h p-rel" vars='&vars;'>
  <header class="f j-bw">
    <h1 class="m0 p0" id="title">&topic;</h1>
    <div id="year">&year;</div>
  </header>
  <hr />
  <section class="f j-bw fw4">
    <div id="frontmatter-lhs">
      <div id="author">&author;</div>
      <div id="from">&from;</div>
      <div id="date">&date;</div>
    </div>
    <div class="p10" id="frontmatter-rhs">
      <img src="/iitm.svg" height="100px" width="100px" alt="">
    </div>
  </section>
  <hr />
  &body;
</body>

</html>