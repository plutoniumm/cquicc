<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/aaaakshat/cm-web-fonts@latest/fonts.css">
  <link rel="stylesheet" href="https://manav.ch/atomic.css">
  <link rel="stylesheet" href="/cquicc.css">
  <link rel="stylesheet" href="/hljs.css">

  <script>
    var $ = ( selector ) => document.querySelector( selector )
    var $$ = ( selector ) => [ ...document.querySelectorAll( selector ) ]
    var loop = ( fn ) => setTimeout( fn, 1000 );

    var setScroll = () => localStorage.setItem( 'scrollPosition', window.scrollY );
    var getScroll = () => {
      const p = localStorage.getItem( 'scrollPosition' )
      if ( p ) window.scrollTo( 0, parseInt( p ) );
    };

    function makeAlerts ( list ) {
      console.log( list, AlertsDiv );
      if ( !list.length ) {
        AlertsDiv.parentElement.classList.add( "o-0" );
        return 0;
      } else {
        AlertsDiv.parentElement.classList.remove( "o-0" );

        list = list.map( ( [ type, text ], index ) => `
        <div class="alert"">${ index }. ${ type }: <br />
          <div class="p0">${ text }</div>
        </div>
        `);
        console.log( list );
        AlertsDiv.innerHTML = list.join( "" );
      }
    };

    window.addEventListener( 'scroll', setScroll );
    window.addEventListener( 'load', getScroll );
  </script>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize( { securityLevel: 'antiscript', theme: "base" } );
    loop( () => mermaid.init( undefined, $$( '.mermaid' ) ) )
  </script>
  <script>
    loop( () => {
      let alerts = []; // type, text
      // init
      $( ".split" ).style.height = "calc(29.7cm - 3em - 4cm)";
      const vars = JSON.parse(
        document.body.getAttribute( "vars" )
          .replaceAll( "&quot;", "\"" )
      )

      // process citations
      const cites = $$( "a[href*='ref']" );
      cites.forEach( e => {
        let [ num, ...rest ] = e.innerText.split( "." );
        rest = rest.join( "." );

        console.log( num, rest );
        e.outerHTML =
          `<div class="def" id="fn${ num }">
            <a href="${ e.href + num }">[${ num }]</a>
            ${ rest }
          </div>`;
      } );
      // alert if no citations
      if ( !cites.length )
        alerts.push( [ "no-cites", "Dawg you got no citations?" ] );

      // other splits after first
      $$( ".split" ).slice( 1 ).forEach( ( split, index ) => {
        const exists = document.querySelector( `#top${ index }` );
        if ( exists ) return;

        const hr = document.createElement( "hr" );
        hr.id = `top${ index }`;
        split.insertBefore( hr, split.firstChild );
      } );

      // footer
      $$( ".postp" ).forEach( ( e, i ) => {
        e.innerHTML = `<div>${ vars.author }, ${ vars.from }</div>
        <div>${ i + 1 }</div>`
      } );

      // images
      $$( "img,svg" ).forEach( e => {
        if ( e.hasAttribute( "nocite" ) ) return 0;
        if ( e.outerHTML.includes( "mermaid" ) ) return 0;

        let id = e.getAttribute( "eid" );
        if ( !id ) {
          id = "p" + ( Math.random() * 1e6 | 0 ).toString( 36 );
          e.setAttribute( "eid", id )
        };

        const cited = $( `#${ id }` );
        if ( cited ) return 0;

        let url = e.getAttribute( "url" ) || e.getAttribute( "src" );
        if ( !url ) return alerts.push( [ "no-src", e.outerHTML ] );
        try { url = new URL( url ).hostname; } catch ( e ) { }

        const alt = e.getAttribute( "alt" );
        if ( !alt ) return alerts.push( [ "no-alt", e.outerHTML ] );

        const grey = `<div id="${ id }" class="img-expl">
          ${ alt.replaceAll( "\"", "" ) }, <i>${ url }</i>
        </div>`;
        e.insertAdjacentHTML( "afterend", grey );
      } );

      // code
      $$( '.katex' ).forEach( e => {
        e.outerHTML = `<span class="katex">${ e.querySelector( "math" ).outerHTML }</span>`;
      } );
      // headings in pseudocode gen
      $$( "h2" ).forEach( e => {
        if ( e.innerHTML.charAt( 0 ) !== "|" ) return 0;
        e.outerHTML = `<div>${ e.innerHTML.slice( 1 ) }</div><hr/>`;
      } );

      makeAlerts( alerts );
    } );
  </script>

  &head;
</head>

<body class="flow-x-h p-rel" vars='&vars;' xmlns="http://www.w3.org/2000/svg">
  <details class="p-fix noprint mx-a rpm-10 blur f fw j-ar">
    <summary>Alerts</summary>
    <div id="alerts"></div>
  </details>
  <header class="f j-bw">
    <h1 class="m0 p0" id="title">&topic;</h1>
    <div id="year">&year;</div>
  </header>
  <hr />
  <section class="f j-bw fw4">
    <div id="frontmatter-lhs">
      <div id="author">&author;</div>
      <div id="from">&from;</div>
      <div id="date">&date;</div>
    </div>
    <div class="p10" id="frontmatter-rhs">
      <img src="/iitm.svg" height="100px" width="100px" nocite>
    </div>
  </section>
  <hr />
  &body;
</body>

<script>
  var AlertsDiv = $( "#alerts" );
</script>

</html>